# üßÆ –ê–ª–≥–æ—Ä–∏—Ç–º—ã –∏ –ª–æ–≥–∏–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (v2.0)

## –û–±–∑–æ—Ä

–í –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ v2.0 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–≥–∏–±—Ä–∏–¥–Ω–∞—è –º–æ–¥–µ–ª—å –≤—ã—á–∏—Å–ª–µ–Ω–∏–π**:
1.  **Frontend (Client-Side)**: –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ (IndexedDB) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Web Workers.
2.  **Backend (PostgreSQL)**: –í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–∞–∑–µ —á–µ—Ä–µ–∑ SQL-—Ñ—É–Ω–∫—Ü–∏–∏ (v5).

---

## üî¢ 1. –†–∞—Å—á–µ—Ç –≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ (FTDNA Standard)

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏–π FTDNA, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –ø—Ä–æ—Å—Ç–æ–π –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–∑–Ω–∏—Ü—ã.

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
- **Frontend**: `str-matcher/src/utils/calculations.ts` -> `calculateGeneticDistance`
- **Backend**: PostgreSQL —Ñ—É–Ω–∫—Ü–∏—è `calculate_marker_distance`

### –ê–ª–≥–æ—Ä–∏—Ç–º
–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞:

1.  **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã** (–Ω–∞–ø—Ä–∏–º–µ—Ä, DYS393, DYS390):
    - –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∞–±—Å–æ–ª—é—Ç–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞: `|val1 - val2|`.
    - **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ (Cap)**: –†–∞–∑–Ω–∏—Ü–∞ **–Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 2**.
    - *–ü—Ä–∏–º–µ—Ä*:
        - 13 vs 14 -> –î–∏—Å—Ç–∞–Ω—Ü–∏—è 1
        - 13 vs 15 -> –î–∏—Å—Ç–∞–Ω—Ü–∏—è 2
        - 13 vs 16 -> –î–∏—Å—Ç–∞–Ω—Ü–∏—è 2 (Cap applied)
        - 13 vs 20 -> –î–∏—Å—Ç–∞–Ω—Ü–∏—è 2 (Cap applied)

2.  **–ü–∞–ª–∏–Ω–¥—Ä–æ–º–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã** (DYS385, DYS459, DYS464):
    - –°—á–∏—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ–¥–∏–Ω—ã–π –±–ª–æ–∫.
    - –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é (–∫–∞–∫ —Å—Ç—Ä–æ–∫–∏) -> –î–∏—Å—Ç–∞–Ω—Ü–∏—è **–≤—Å–µ–≥–¥–∞ 1**.
    - *–ü—Ä–∏–º–µ—Ä DYS385*:
        - 11-14 vs 11-14 -> –î–∏—Å—Ç–∞–Ω—Ü–∏—è 0
        - 11-14 vs 11-15 -> –î–∏—Å—Ç–∞–Ω—Ü–∏—è 1
        - 11-14 vs 13-18 -> –î–∏—Å—Ç–∞–Ω—Ü–∏—è 1

3.  **–ò—Ç–æ–≥–æ–≤–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è**: –°—É–º–º–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏–π –ø–æ –≤—Å–µ–º –æ–±—â–∏–º –º–∞—Ä–∫–µ—Ä–∞–º.

### –ö–æ–¥ (TypeScript)
```typescript
// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
// Matches PostgreSQL calculate_marker_distance logic
Math.min(Math.abs(val2 - val1), 2);
```

---

## üîç 2. –ê–ª–≥–æ—Ä–∏—Ç–º—ã –ø–æ–∏—Å–∫–∞ (Matching)

### A. Client-Side (–õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã)
–†–∞–±–æ—Ç–∞–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ —á–µ—Ä–µ–∑ Web Worker (`comparison.worker.ts`).

1.  **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: –ò—Å–∫–ª—é—á–∞—é—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –º–µ–Ω—å—à–µ 80% –æ–±—â–∏—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ —Å –∑–∞–ø—Ä–æ—Å–æ–º.
2.  **–†–∞—Å—á–µ—Ç**: –î–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è.
3.  **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞**:
    - –ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏.
    - –ü—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ - –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–≤–ø–∞–≤—à–∏—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ (desc).

### B. Server-Side (–ì–ª–æ–±–∞–ª—å–Ω–∞—è –±–∞–∑–∞)
–†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ PostgreSQL —Ñ—É–Ω–∫—Ü–∏—é `find_matches_batch` (v5).

**–ö–ª—é—á–µ–≤—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**:
- **GIST –∏–Ω–¥–µ–∫—Å—ã**: –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –º–∞—Å—Å–∏–≤–∞–º JSONB.
- **–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: SQL-–∑–∞–ø—Ä–æ—Å –æ—Ç—Å–µ–∫–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª–∏ —Å —è–≤–Ω—ã–º –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø (–µ—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –∞–∫—Ç–∏–≤–µ–Ω).

---

## üå≥ 3. –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø–∞–º–∏

### –û–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (Batch API)
–ü–æ—Å–ª–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π (Match), Frontend –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Ö –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø (–≤–∫–ª—é—á–∞—è —Å—É–±–∫–ª–∞–¥—ã).

**–ü—Ä–æ–±–ª–µ–º–∞ N+1**: –†–∞–Ω—å—à–µ –¥–µ–ª–∞–ª—Å—è HTTP –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞—Ç—á–∞.
**–†–µ—à–µ–Ω–∏–µ v2 (Batch API)**:
1.  Frontend —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø—ã –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 50 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–∑ 1000 –º–∞—Ç—á–µ–π).
2.  –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **–æ–¥–∏–Ω** –∑–∞–ø—Ä–æ—Å `POST /api/batch-check-subclades`.
3.  Backend (Legacy Service) –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø—ã –≤ –¥–µ—Ä–µ–≤–æ.
4.  –†–µ–∑—É–ª—å—Ç–∞—Ç –∫—ç—à–∏—Ä—É–µ—Ç—Å—è.

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å—É–±–∫–ª–∞–¥–æ–≤
```typescript
// str-matcher/src/utils/calculations.ts

export async function processMatches(matches: Match[], filters: Filters) {
    // 1. –ò–∑–≤–ª–µ—á—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø—ã
    const uniqueHaplo = new Set(matches.map(m => m.haplogroup));

    // 2. Batch API –∑–∞–ø—Ä–æ—Å
    const response = await api.post('/batch-check-subclades', {
        haplogroups: [...uniqueHaplo],
        parent: filterHaplogroup
    });

    // 3. –ë—ã—Å—Ç—Ä–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ –ø–∞–º—è—Ç–∏
    return matches.filter(m => response.results[m.haplogroup] === true);
}
```

---

## üé® 4. –†–µ–¥–∫–æ—Å—Ç—å –º–∞—Ä–∫–µ—Ä–æ–≤ (Rarity Calculation)

–°–∏—Å—Ç–µ–º–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–µ—Ç —Ä–µ–¥–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤.

**–ê–ª–≥–æ—Ä–∏—Ç–º**:
1.  –ë–µ—Ä–µ—Ç—Å—è –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –º–∞—Ç—á–µ–π (>5 —à—Ç—É–∫).
2.  –î–ª—è –∫–∞–∂–¥–æ–π —è—á–µ–π–∫–∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è —á–∞—Å—Ç–æ—Ç–∞ –≤—Å—Ç—Ä–µ—á–∞–µ–º–æ—Å—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —ç—Ç–æ–º –Ω–∞–±–æ—Ä–µ.
3.  **–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞**:
    - < 4%: **–ö—Ä–∞—Å–Ω—ã–π** (–û—á–µ–Ω—å —Ä–µ–¥–∫–æ–µ)
    - 4-8%: **–û—Ä–∞–Ω–∂–µ–≤—ã–π**
    - 8-12%: **–ñ–µ–ª—Ç—ã–π**

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `rarityCache` (Memoization) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –ø—Ä–∏ —Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ —Ç–∞–±–ª–∏—Ü. –ö—ç—à –∂–∏–≤–µ—Ç 5 –º–∏–Ω—É—Ç.

---

*–î–æ–∫—É–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω: –Ø–Ω–≤–∞—Ä—å 2026 (v2.0 Logic Verified)*



