# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã DNA-utils-universal (Hybrid v2.0)

## üî≠ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

**DNA-utils-universal v2.0** ‚Äî —ç—Ç–æ –≥–∏–±—Ä–∏–¥–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ Y-STR –º–∞—Ä–∫–µ—Ä–æ–≤, —Å–æ—á–µ—Ç–∞—é—â–∞—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π —Å –º–æ—â–Ω–æ—Å—Ç—å—é —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –±–∞–∑–µ —Ç—Ä–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤.

## üèõÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å—Ö–µ–º–∞

```mermaid
graph TD
    User[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å] --> Frontend[Frontend Service<br/>(str-matcher :3000/:9002)]
    
    subgraph "Client Side (Browser)"
        Frontend --> |Web Workers| Worker[–ü–æ–∏—Å–∫–æ–≤—ã–π –¥–≤–∏–∂–æ–∫]
        Frontend --> |IndexedDB| LocalDB[–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î]
    end
    
    subgraph "Server Side"
        Frontend --> |Proxy /api/*| Haplo[Legacy Haplo Service<br/>(ftdna_haplo :9003)]
        Frontend --> |CORS /api/*| Backend[Backend Service<br/>(backend :9005)]
        
        Backend --> Postgres[(PostgreSQL)]
        Backend --> Redis[(Redis Cache)]
        
        Haplo --> JSON[(Static JSON Trees)]
    end
```

---

## üß© –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. Frontend & Client-Side Engine (`str-matcher`)
**–°—Ç–µ–∫:** Next.js 14, React, TypeScript, Redux Toolkit, Web Workers.
**–ü–æ—Ä—Ç:** `:3000`.

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
*   **UI/UX:** –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
*   **–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫:** –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è STR-–º–∞—Ä–∫–µ—Ä–æ–≤ –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (Privacy-first).
*   **–ì–∏–±—Ä–∏–¥–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `IndexedDB` –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π.

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–¥—É–ª–∏:**
*   `workers/comparison.worker.ts`: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—è–∂–µ–ª—ã—Ö —Ä–∞—Å—Å—á–µ—Ç–æ–≤ –≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –≤ background thread.
*   `utils/calculations.ts`: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ (Genetic Distance, Rarity, etc.).
*   `hooks/useSTRMatcher.ts`: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–∏—Å–∫–∞.

### 2. Backend Service (`backend`)
**–°—Ç–µ–∫:** Node.js, Express, PostgreSQL, Redis, BullMQ.
**–ü–æ—Ä—Ç:** `:9005`.

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
*   **–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫:** –ü–æ–∏—Å–∫ –ø–æ –º–∏–ª–ª–∏–æ–Ω–∞–º –ø—Ä–æ—Ñ–∏–ª–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º GIST-–∏–Ω–¥–µ–∫—Å–æ–≤ PostgreSQL (`find_matches_v5`).
*   **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏:** CRUD –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, API –∫–ª—é—á–∏.
*   **–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö CSV –¥–∞–º–ø–æ–≤ (AADNA –∏ –¥—Ä.).

**–ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
*   **PostgreSQL:** –û—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (—Ç–∞–±–ª–∏—Ü—ã `str_profiles`, `samples`).
*   **Redis:** –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—á–µ—Ä–µ–¥–µ–π –∑–∞–¥–∞—á.
*   **Express:** REST API endpoints.

### 3. Legacy Haplo Service (`ftdna_haplo`)
**–°—Ç–µ–∫:** Node.js, Express, Static JSON.
**–ü–æ—Ä—Ç:** `:9003`.

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
*   **–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø:** –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–ª–æ–≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ä–µ–≤—å—è—Ö (FTDNA, YFull).
*   **Batch Analysis:** –ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–±–∫–ª–∞–¥–æ–≤ –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞.
*   **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è:** Frontend –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã `/api/*` (–∫—Ä–æ–º–µ –∞–¥–º–∏–Ω–∫–∏) –Ω–∞ —ç—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å.

---

## üîÑ –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (Data Flow)

### 1. –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ (Client-Side)
1.  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç CSV –∏–ª–∏ –≤—ã–±–∏—Ä–∞–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.
2.  –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ `IndexedDB` –±—Ä–∞—É–∑–µ—Ä–∞.
3.  –ü—Ä–∏ –ø–æ–∏—Å–∫–µ `Web Worker` —Å–∫–∞–Ω–∏—Ä—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É.
4.  –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è (FTDNA-–º–µ—Ç–æ–¥) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.
5.  –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ Main Thread –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞.

### 2. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ (Server-Side)
1.  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∏—Å–∫ –ø–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–∞–∑–µ.
2.  Frontend –¥–µ–ª–∞–µ—Ç –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ `Backend Service` (:9005).
3.  SQL-—Ñ—É–Ω–∫—Ü–∏—è `find_matches_v5` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º GIST-–∏–Ω–¥–µ–∫—Å–∞.
4.  –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.

### 3. –û–±–æ–≥–∞—â–µ–Ω–∏–µ –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø (Batch API)
1.  –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è matches (–ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö), Frontend —Å–æ–±–∏—Ä–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø—ã.
2.  –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **–æ–¥–∏–Ω** Batch-–∑–∞–ø—Ä–æ—Å –Ω–∞ `ftdna_haplo` (:9003).
3.  –°–µ—Ä–≤–∏—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–µ—Ä–∞—Ä—Ö–∏—é –∏ —Å—Ç–∞—Ç—É—Å —Å—É–±–∫–ª–∞–¥–æ–≤.
4.  Frontend —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞.

---

## üíæ –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### PostgreSQL (Backend)
–°—Ö–µ–º–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –±–ª–∏–∂–∞–π—à–∏—Ö —Å–æ—Å–µ–¥–µ–π.
*   `str_values` (IntArray): –ú–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π –º–∞—Ä–∫–µ—Ä–æ–≤ –¥–ª—è GIST –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.
*   `haplogroup` (Varchar): –î–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.

### IndexedDB (Frontend)
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Dexie.js` –∏–ª–∏ –Ω–∞—Ç–∏–≤–Ω—ã–π IDB –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

### Static JSON (Haplo Service)
–î–µ—Ä–µ–≤—å—è FTDNA –∏ YFull —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö, –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö –≤ –ø–∞–º—è—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞.

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ (Ecosystem)

–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Ä–∫–µ—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ PM2 (`ecosystem.config.js`).

| App Name | Path | Port | Env Vars |
|----------|------|------|----------|
| `str-matcher-app` | `./str-matcher` | `9002` | `HAPLO_API_URL` |
| `dna-backend` | `./backend` | `9005` | `DATABASE_URL`, `REDIS_URL` |
| `ftdna-haplo-app` | `./ftdna_haplo` | `9003` | `PORT` |

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1.  **CORS:** Backend (:9005) —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ —Å –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (Frontend).
2.  **Proxy:** –ò–∑–æ–ª—è—Ü–∏—è Legacy —Å–µ—Ä–≤–∏—Å–∞ –∑–∞ Next.js Rewrites —Å–∫—Ä—ã–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É API.
3.  **API Keys:** –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ Backend –∑–∞—â–∏—â–µ–Ω—ã Static API Keys.
