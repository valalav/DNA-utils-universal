# API Configuration Guide

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ API (Hybrid v2.0)

–í –ø—Ä–æ–µ–∫—Ç–µ –≤–µ—Ä—Å–∏–∏ 2.0 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–≥–∏–±—Ä–∏–¥–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** –∏–∑ —Ç—Ä–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä—Ç–æ–≤ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∫—Ä–∏—Ç–∏—á–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã.

### üß© –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –ü–æ—Ä—Ç—ã

| –°–µ—Ä–≤–∏—Å | –ü–æ—Ä—Ç (Dev) | –ü–æ—Ä—Ç (Prod) | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|------------|-------------|------------|
| **Frontend** (`str-matcher`) | `:3000` | `:9002` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ (Web Workers) |
| **Legacy Haplo** (`ftdna_haplo`) | `:9003` | `:9003` | –î–µ—Ä–µ–≤—å—è –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø, Batch-–ø—Ä–æ–≤–µ—Ä–∫–∏, Autocomplete |
| **Backend** (`backend`) | `:9004` | `:9004` | –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ (PostgreSQL), –ê–¥–º–∏–Ω–∫–∞, API –ö–ª—é—á–∏ |

---

## ÔøΩ –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

Frontend (`str-matcher`) –æ–±—â–∞–µ—Ç—Å—è —Å –±—ç–∫–µ–Ω–¥-—Å–µ—Ä–≤–∏—Å–∞–º–∏ –¥–≤—É–º—è —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏:

### 1. Proxy (—á–µ—Ä–µ–∑ Next.js Rewrites) -> Legacy Haplo (:9003)
**–î–ª—è —á–µ–≥–æ:** –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø–∞–º–∏, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–±–∫–ª–∞–¥–æ–≤, –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ.
**–ú–µ—Ö–∞–Ω–∏–∑–º:** Next.js –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `/api/` –Ω–∞ –ø–æ—Ä—Ç 9003.

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`str-matcher/next.config.js`):**
```javascript
async rewrites() {
  return [
    {
      source: '/api/:path*',
      destination: `${process.env.HAPLO_API_URL || 'http://localhost:9003'}/api/:path*`,
    },
  ]
}
```

### 2. Direct CORS Fetch -> Backend (:9004)
**–î–ª—è —á–µ–≥–æ:** –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, —Ä–∞–±–æ—Ç–∞ —Å API –∫–ª—é—á–∞–º–∏, –≥–ª–æ–±–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö.
**–ú–µ—Ö–∞–Ω–∏–∑–º:** –ü—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –ø–æ—Ä—Ç 9004. –¢—Ä–µ–±—É–µ—Ç –≤–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ CORS –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (`admin/keys/page.tsx`):**
```typescript
const backendUrl = window.location.hostname === 'localhost' 
  ? 'http://localhost:9004' 
  : 'https://pystr.valalav.ru/backend-search'; // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

fetch(`${backendUrl}/api/admin/keys`, ...);
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### 1. Frontend (`str-matcher`)
–§–∞–π–ª `.env.local` **–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø** –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è fallback-–∑–Ω–∞—á–µ–Ω–∏—è.

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- `HAPLO_API_URL`: URL —Å–µ—Ä–≤–∏—Å–∞ –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø (–ø–æ —É–º.: `http://localhost:9003`)
- `NEXT_PUBLIC_BACKEND_URL`: URL –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±—ç–∫–µ–Ω–¥–∞ (–ø–æ —É–º. –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–ª—è localhost)

### 2. Backend (`backend`)
–§–∞–π–ª `backend/.env` (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω):
```ini
PORT=9004
DATABASE_URL=postgres://...
REDIS_URL=redis://...
CORS_ORIGIN=http://localhost:3000,http://localhost:9002
```

### 3. Legacy Haplo (`ftdna_haplo`)
–§–∞–π–ª `ftdna_haplo/.env`:
```ini
PORT=9003
API_PATH=/api
```

---

## üöÄ Production Configuration (PM2 + Systemd)

–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Å–µ—Ä–≤–∏—Å—ã —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ **PM2** (Node.js) –∏ **Systemd** (PostgreSQL, Netbird).

### Systemd / PM2 Architecture (Internal Node)

| –°–µ—Ä–≤–∏—Å | –ü–æ—Ä—Ç | –ú–µ–Ω–µ–¥–∂–µ—Ä | –°—Ç–∞—Ç—É—Å |
|--------|------|----------|--------|
| **str-matcher** | 3000 | PM2 | ‚úÖ active |
| **backend** | 9005 | PM2 | ‚úÖ active |
| **ftdna-haplo-app** | 9003 | PM2 | ‚úÖ active |
| **PostgreSQL** | 5432 | Systemd | ‚úÖ active |

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ecosystem.config.js
–§–∞–π–ª —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ Node.js —Å–µ—Ä–≤–∏—Å–∞–º–∏:

```javascript
module.exports = {
  apps: [
    {
      name: "ftdna-haplo-app",
      script: "./server/server.js",
      cwd: "./ftdna_haplo",
      env: { PORT: 9003, NODE_ENV: "production" }
    },
    {
      name: "backend",
      script: "./server.js",
      cwd: "./backend",
      env: { PORT: 9005, NODE_ENV: "production" } // Port 9005!
    },
    {
      name: "str-matcher-app",
      script: "npm",
      args: "start",
      cwd: "./str-matcher",
      env: { PORT: 3000 }
    }
  ]
}
```

---

## üîß Troubleshooting

### "500 Internal Server Error" (/api/check-subclade)
*   **–ü—Ä–∏—á–∏–Ω–∞:** –°–µ—Ä–≤–∏—Å `ftdna-haplo` (–ø–æ—Ä—Ç 9003) –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ —É–ø–∞–ª.
*   **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `pm2 logs ftdna-haplo-app` –∏–ª–∏ `npm run dev` —Ç–µ—Ä–º–∏–Ω–∞–ª.

### "CORS Error" (–ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ /api/admin)
*   **–ü—Ä–∏—á–∏–Ω–∞:** –°–µ—Ä–≤–∏—Å `backend` (–ø–æ—Ä—Ç 9004) –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç Origin –≤–∞—à–µ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞.
*   **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CORS –≤ `backend/server.js` –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `http://localhost:3000` (–∏–ª–∏ –≤–∞—à –ø–æ—Ä—Ç) –µ—Å—Ç—å –≤ whitelist.

### "404 Not Found" (–ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ /api/...)
*   **–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Rewrites –∏–ª–∏ —Å–µ—Ä–≤–∏—Å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.
*   **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—Ç (9003 –¥–ª—è –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø, 9004 –¥–ª—è –∞–¥–º–∏–Ω–∫–∏). –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ `/api/` –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 9003 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é!
```
