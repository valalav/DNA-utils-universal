# üìÇ –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã –∏ –∏—Ö —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

## –û–±–∑–æ—Ä

–í —ç—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ –æ–ø–∏—Å–∞–Ω—ã –≤—Å–µ –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–∏—Å—Ç–µ–º—ã DNA-utils-universal, –∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ, –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º.

**–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å**: –Ø–Ω–≤–∞—Ä—å 2026 (v2.0 Architecture)

---

## üèóÔ∏è Backend Service (Core)
**–ü—É—Ç—å**: `backend/`
**–ü–æ—Ä—Ç**: 9004

–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏ (PostgreSQL) –∏ –º–∞—Ç—á–∏–Ω–≥–∞.

### `backend/server.js` - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: Express —Å–µ—Ä–≤–µ—Ä, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Middleware (CORS, Helmet, Rate Limit).
**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL —á–µ—Ä–µ–∑ `pg-pool`.
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Redis –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—á–µ—Ä–µ–¥–µ–π Bull.
- –†–æ—É—Ç–∏–Ω–≥ API (`/api/profiles`, `/api/admin`, –∏ —Ç.–¥.).

### `backend/services/matchingService.js`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π.
**–õ–æ–≥–∏–∫–∞**:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **SQL —Ñ—É–Ω–∫—Ü–∏–∏ v5** (`find_matches_v5`) –¥–ª—è —Å–≤–µ—Ä—Ö–±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ –ë–î.
- –†–µ–∞–ª–∏–∑—É–µ—Ç –¥–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π –ø–æ–∏—Å–∫:
  1. –ì—Ä—É–±—ã–π –æ—Ç—Å–µ–≤ –ø–æ SQL –∏–Ω–¥–µ–∫—Å—É (GiST/GIN).
  2. –¢–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ (Genetic Distance) –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î.

### `backend/routes/profiles.js`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è–º–∏.
- `POST /find-matches`: –ü–æ–∏—Å–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π.
- `POST /upload`: –ó–∞–≥—Ä—É–∑–∫–∞ CSV/Excel (–ø–æ—Ç–æ–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞).

---

## üéØ str-matcher - Frontend
**–ü—É—Ç—å**: `str-matcher/`
**–ü–æ—Ä—Ç**: 9002 (Next.js App Router)

### –ì–ª–∞–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### `src/app/page.tsx` - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–º SSR.

#### `src/components/str-matcher/STRMatcher.tsx`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ö–æ—Ä–µ–Ω—å UI –ª–æ–≥–∏–∫–∏.
- –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (–∑–∞–ø—Ä–æ—Å, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, —Ñ–∏–ª—å—Ç—Ä—ã).
- –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç `useSTRMatcher` hook.

#### `src/hooks/useSTRMatcher.ts`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°–≤—è–∑—É—é—â–µ–µ –∑–≤–µ–Ω–æ –º–µ–∂–¥—É UI –∏ –≤–æ—Ä–∫–µ—Ä–∞–º–∏.
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Web Workers.
- –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.

#### `src/utils/calculations.ts`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –£—Ç–∏–ª–∏—Ç—ã –∏ API –≤—ã–∑–æ–≤—ã.
- **`processMatches`**: –†–µ–∞–ª–∏–∑—É–µ—Ç **Batch API** –≤—ã–∑–æ–≤—ã –∫ backend'—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É–±–∫–ª–∞–¥–æ–≤.
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: `haplogroupCache` –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
- **`calculateMarkerRarity`**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è (–º–µ–º–æ–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è) —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Ä–µ–¥–∫–æ—Å—Ç–∏ –∞–ª–ª–µ–ª–µ–π.

### Web Workers

#### `src/workers/comparison.worker.ts`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –§–æ–Ω–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–π (–¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞).
**–õ–æ–≥–∏–∫–∞**:
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞–∫–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π.
- –°—á–∏—Ç–∞–µ—Ç –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ Main Thread.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `postMessage` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.

---

## üå≥ ftdna_haplo - Legacy Haplo Service
**–ü—É—Ç—å**: `ftdna_haplo/`
**–ü–æ—Ä—Ç**: 9003 (Node.js)

–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∏–ª–æ–≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–º–∏ –¥–µ—Ä–µ–≤—å—è–º–∏ (FTDNA + YFull). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ "Read-Only" –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–Ω–∞–Ω–∏–π –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –≥–∞–ø–ª–æ–≥—Ä—É–ø–ø.

### `server/server.js`
–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞. –ó–∞–≥—Ä—É–∂–∞–µ—Ç `get.json` –∏ `ytree.json` –≤ –ø–∞–º—è—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (Heap ~400MB).

### `haplo_functions.js`
–†–µ–∞–ª–∏–∑—É–µ—Ç –≥—Ä–∞—Ñ–æ–≤—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã:
- `isSubclade`: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏.
- `getPathToRoot`: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—É—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏.

---

## üîÑ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (Hybrid Architecture)

1. **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö**:
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç CSV -> –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ **IndexedDB** –±—Ä–∞—É–∑–µ—Ä–∞.
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (AADNA) -> –î–∞–Ω–Ω—ã–µ —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –∏–∑ **Backend** (–∏–ª–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞) –≤ **IndexedDB**.

2. **–ü–æ–∏—Å–∫ (Client-Side)**:
   - **Frontend** –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ **Web Workers** (`comparison.worker.ts`).
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä).
   - –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.

3. **–û–±–æ–≥–∞—â–µ–Ω–∏–µ (Server-Side)**:
   - –ü–æ—Å–ª–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –º–∞—Ç—á–µ–π, **Frontend** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ **Legacy Haplo Service** (Port 9003) –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É–±–∫–ª–∞–¥–æ–≤ (Batch API `processMatches`).
   - **Backend** (Port 9004) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ "–≥–ª–æ–±–∞–ª—å–Ω—ã—Ö" –¥–∞–Ω–Ω—ã—Ö.

#### `src/utils/calculations.ts`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –£—Ç–∏–ª–∏—Ç—ã –∏ API –≤—ã–∑–æ–≤—ã.
- **`processMatches`**: –†–µ–∞–ª–∏–∑—É–µ—Ç **Batch API** –≤—ã–∑–æ–≤—ã –∫ backend'—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É–±–∫–ª–∞–¥–æ–≤ (–ø–æ—Å–ª–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞).
